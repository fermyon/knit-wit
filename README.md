# `@fermyon/knit-wit`

This package provides a way to package `npm` packages that depend on the `wasi` imports to be built using [`ComponentizeJS`](https://github.com/bytecodealliance/ComponentizeJS). This repository includes both a library and a node executable.

## `knit-wit.json`

This configuration file plays a central role in defining how the `knit-wit` tool interacts with your project. The file specifies the packages, their corresponding wit paths, and the world names necessary for building with `wasi` imports. This file is edited by the postinstall executable and read by the library. The schema for this file is defined using yup for validation and looks like this:

```javascript
let knitWitConfigSchema = object({
  version: number().required(),
  packages: array(
    object({
      name: string().required(),
      witPath: string().required(),
      world: string().required(),
    })
  ),
});
```
Here's an example of what a knit-wit.json file might look like:

```json
{
  "version": 1,
  "packages": [
    {
      "name": "example-package-1",
      "witPath": "path/to/example1.wit",
      "world": "exampleWorld1"
    },
    {
      "name": "example-package-2",
      "witPath": "path/to/example2.wit",
      "world": "exampleWorld2"
    }
  ]
}
```

## Library and Usage
 
The @fermyon/knit-wit package provides a function knitWit to parse knit-wit.json, merging packages and their required worlds into a unified output package.

The library exposes one function `knitWit` which has the following signature:

```js
interface knitWitOptions {
    witPaths?: string[];
    worlds?: string[];
    outputWorld?: string;
    outputPackage?: string;
    outDir?: string;
}
export declare function knitWit(opts?: knitWitOptions, ignoreConfigFile?: boolean): Promise<void>;
```

- `witPaths` and `worlds` in opts are concatenated with those parsed from knit-wit.json.
- Additional options in opts include:
  - `outputWorld`: Name of the world in the generated wit package (default: "combined").
  - `outputPackage`: Package specifier in the generated wit package (default: "local:combined").
  - `outDir`: Directory where the generated wit package is saved (default: "combined-wit").

To ignore parsing the config file, set ignoreConfigFile to true.

### usage

```js
import { knitWit } from '@fermyon/knit-wit';

knitWit({ worlds: ["additionalWorld1", "additionalWorld2"] });
```

The output generated by the above can then be used as input to `ComponentizeJS`.

## Postinstall Executable

It can be found in `bin/knit-wit-postinstall.js`, this can be used in the postinstall scripts of packages that use `wasi` imports to update the `knit-wit.json`. The executable uses configuration provided in the `package.json` to update `knit-wit.json`. 

The following field needs to be added to the `config` key of the  `package.json` :

- `knitwit.witPath` - The relative path to the `wit` file/folder from the `main` entrypoint of the package. 
- `knitwit.world` - The name of the world that contains all the names required for the package. 

An example of how the configuration will look is as below:

```json
{
    ...
    "config": {
        "knitwit": {
            "witPath": "<relative path to wit from entrypoint>",
            "world": "<world with all imports>"
        }
    }
    ...
}
```

The executable needs to be added to the `postinstall` script after adding the `@fermyon/knit-wit` package to the dependency list. 

```json
{
    ...
    "scripts": {
        "postinstall": "knit-wit-postinstall"
    }
    ...
}
```

**Note:** The postinstall script should not include `npx` as that will alter the environment variables which the executable relies on to run in the context of the consumer. 